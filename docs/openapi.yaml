openapi: 3.0.3
info:
  title: Secrets API
  version: v1
  description: >-
    Baseline OpenAPI specification for Secrets API v1. This is intentionally concise
    and focuses on high-traffic endpoints and common payloads. OpenAPI path templates
    use `{param}` syntax while runtime router/metrics labels may expose `:param` or
    wildcard forms such as `*path`.
servers:
  - url: http://localhost:8080
    description: Local development
tags:
  - name: auth
  - name: clients
  - name: secrets
  - name: transit
  - name: tokenization
  - name: audit
paths:
  /health:
    get:
      tags: [auth]
      summary: Health check
      responses:
        "200":
          description: Healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
  /v1/token:
    post:
      tags: [auth]
      summary: Issue bearer token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TokenRequest"
      responses:
        "201":
          description: Token issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          $ref: "#/components/responses/ValidationError"
        "423":
          $ref: "#/components/responses/Locked"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/clients:
    get:
      tags: [clients]
      summary: List clients
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Clients list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      additionalProperties: true
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "429":
          $ref: "#/components/responses/TooManyRequests"
    post:
      tags: [clients]
      summary: Create client
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClientCreateRequest"
      responses:
        "201":
          description: Client created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  secret:
                    type: string
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/clients/{id}/unlock:
    post:
      tags: [clients]
      summary: Unlock client account
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Client unlocked
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: Client not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/secrets:
    get:
      tags: [secrets]
      summary: List secrets
      security:
        - bearerAuth: []
      parameters:
        - name: offset
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: Secrets list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/SecretWriteResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/secrets/{path}:
    parameters:
      - name: path
        in: path
        required: true
        schema:
          type: string
    post:
      tags: [secrets]
      summary: Create or update secret
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SecretWriteRequest"
      responses:
        "201":
          description: Secret written
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SecretWriteResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
    get:
      tags: [secrets]
      summary: Read latest secret
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Secret value
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SecretReadResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: Secret not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/TooManyRequests"
    delete:
      tags: [secrets]
      summary: Delete latest secret version
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: Secret not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/transit/keys:
    get:
      tags: [transit]
      summary: List transit keys
      security:
        - bearerAuth: []
      parameters:
        - name: offset
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: Transit keys list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/TransitKeyResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "429":
          $ref: "#/components/responses/TooManyRequests"
    post:
      tags: [transit]
      summary: Create transit key
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TransitKeyCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransitKeyResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          description: Transit key already exists (same name with initial version)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: conflict
                message: transit key already exists
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/transit/keys/{name}/encrypt:
    post:
      tags: [transit]
      summary: Encrypt payload using transit key
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                plaintext:
                  type: string
                  description: Base64-encoded plaintext
              required: [plaintext]
      responses:
        "200":
          description: Encrypted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ciphertext:
                    type: string
                  version:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: Transit key not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/transit/keys/{name}/decrypt:
    post:
      tags: [transit]
      summary: Decrypt ciphertext using transit key
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ciphertext:
                  type: string
                  description: Versioned ciphertext in format "<version>:<base64-ciphertext>"
              required: [ciphertext]
            examples:
              validCiphertext:
                summary: Versioned ciphertext from encrypt response
                value:
                  ciphertext: "1:ZW5jcnlwdGVkLWJ5dGVzLi4u"
              invalidCiphertext:
                summary: Invalid ciphertext format
                value:
                  ciphertext: "not-base64!!!"
      responses:
        "200":
          description: Decrypted
          content:
            application/json:
              schema:
                type: object
                properties:
                  plaintext:
                    type: string
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: Transit key not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/tokenization/keys:
    get:
      tags: [tokenization]
      summary: List tokenization keys
      security:
        - bearerAuth: []
      parameters:
        - name: offset
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: Tokenization keys list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/TokenizationKeyResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "429":
          $ref: "#/components/responses/TooManyRequests"
    post:
      tags: [tokenization]
      summary: Create tokenization key
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TokenizationKeyCreateRequest"
      responses:
        "201":
          description: Tokenization key created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenizationKeyResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          description: Tokenization key already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/tokenization/keys/{name}/rotate:
    post:
      tags: [tokenization]
      summary: Rotate tokenization key
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TokenizationKeyRotateRequest"
      responses:
        "201":
          description: New tokenization key version created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenizationKeyResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: Tokenization key not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/tokenization/keys/{id}:
    delete:
      tags: [tokenization]
      summary: Delete tokenization key
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: Tokenization key not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/tokenization/keys/{name}/tokenize:
    post:
      tags: [tokenization]
      summary: Tokenize plaintext
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TokenizeRequest"
      responses:
        "201":
          description: Token created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenizeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: Tokenization key not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/tokenization/detokenize:
    post:
      tags: [tokenization]
      summary: Detokenize token
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DetokenizeRequest"
      responses:
        "200":
          description: Plaintext resolved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DetokenizeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: Token not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/tokenization/validate:
    post:
      tags: [tokenization]
      summary: Validate token
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ValidateTokenRequest"
      responses:
        "200":
          description: Validation result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidateTokenResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/tokenization/revoke:
    post:
      tags: [tokenization]
      summary: Revoke token
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RevokeTokenRequest"
      responses:
        "204":
          description: Revoked
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: Token not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /v1/audit-logs:
    get:
      tags: [audit]
      summary: List audit logs
      security:
        - bearerAuth: []
      parameters:
        - name: offset
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: Audit logs list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      additionalProperties: true
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "422":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/TooManyRequests"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: token
  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Locked:
      description: Account locked due to too many failed authentication attempts
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: client_locked
            message: Account is locked due to too many failed authentication attempts
    TooManyRequests:
      description: Rate limit exceeded
      headers:
        Retry-After:
          description: Seconds to wait before retrying the request
          schema:
            type: string
            example: "1"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: rate_limit_exceeded
            message: Too many requests. Please retry after the specified delay.
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
      required: [error, message]
    TokenRequest:
      type: object
      properties:
        client_id:
          type: string
        client_secret:
          type: string
      required: [client_id, client_secret]
    TokenResponse:
      type: object
      properties:
        token:
          type: string
        expires_at:
          type: string
          format: date-time
      required: [token, expires_at]
    ClientCreateRequest:
      type: object
      properties:
        name:
          type: string
        is_active:
          type: boolean
        policies:
          type: array
          items:
            type: object
            properties:
              path:
                type: string
              capabilities:
                type: array
                items:
                  type: string
      required: [name, policies]
    SecretWriteRequest:
      type: object
      properties:
        value:
          type: string
          description: Base64-encoded plaintext
      required: [value]
    SecretWriteResponse:
      type: object
      properties:
        id:
          type: string
        path:
          type: string
        version:
          type: integer
        created_at:
          type: string
          format: date-time
    SecretReadResponse:
      type: object
      properties:
        id:
          type: string
        path:
          type: string
        version:
          type: integer
        value:
          type: string
          description: Base64-encoded plaintext
        created_at:
          type: string
          format: date-time
    TransitKeyCreateRequest:
      type: object
      properties:
        name:
          type: string
        algorithm:
          type: string
      required: [name, algorithm]
    TransitKeyResponse:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        algorithm:
          type: string
        version:
          type: integer
        created_at:
          type: string
          format: date-time
    TokenizationKeyCreateRequest:
      type: object
      properties:
        name:
          type: string
        format_type:
          type: string
          enum: [uuid, numeric, luhn-preserving, alphanumeric]
        is_deterministic:
          type: boolean
        algorithm:
          type: string
          enum: [aes-gcm, chacha20-poly1305]
      required: [name, format_type, algorithm]
    TokenizationKeyRotateRequest:
      type: object
      properties:
        format_type:
          type: string
          enum: [uuid, numeric, luhn-preserving, alphanumeric]
        is_deterministic:
          type: boolean
        algorithm:
          type: string
          enum: [aes-gcm, chacha20-poly1305]
      required: [format_type, algorithm]
    TokenizationKeyResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        version:
          type: integer
        format_type:
          type: string
        is_deterministic:
          type: boolean
        created_at:
          type: string
          format: date-time
      required: [id, name, version, format_type, is_deterministic, created_at]
    TokenizeRequest:
      type: object
      properties:
        plaintext:
          type: string
          description: Base64-encoded plaintext
        metadata:
          type: object
          additionalProperties: true
        ttl:
          type: integer
          minimum: 1
      required: [plaintext]
    TokenizeResponse:
      type: object
      properties:
        token:
          type: string
        metadata:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true
      required: [token, created_at]
    DetokenizeRequest:
      type: object
      properties:
        token:
          type: string
      required: [token]
    DetokenizeResponse:
      type: object
      properties:
        plaintext:
          type: string
          description: Base64-encoded plaintext
        metadata:
          type: object
          additionalProperties: true
      required: [plaintext]
    ValidateTokenRequest:
      type: object
      properties:
        token:
          type: string
      required: [token]
    ValidateTokenResponse:
      type: object
      properties:
        valid:
          type: boolean
      required: [valid]
    RevokeTokenRequest:
      type: object
      properties:
        token:
          type: string
      required: [token]
