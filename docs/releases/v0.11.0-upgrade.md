# v0.11.0 Upgrade Guide

> Release date: 2026-02-23

This guide covers upgrading from **v0.10.0** to **v0.11.0**.

---

## Overview

v0.11.0 adds account lockout to `POST /v1/token`.

**Key Changes:**

- ✅ Clients locked for 30 minutes after 10 consecutive failed authentication attempts
- ✅ `POST /v1/token` returns `423 Locked` for locked clients
- ✅ Failed attempts reset on successful authentication
- ⚠️ **Database migration 000004 required** (two additive columns on `clients`)

---

## Pre-Migration Checklist

- [ ] **Backup database** before applying migration
- [ ] Verify current version: `./bin/app --version` shows `v0.10.0`
- [ ] Review `LOCKOUT_MAX_ATTEMPTS` and `LOCKOUT_DURATION_MINUTES` defaults (10 and 30)
- [ ] Check client integrations for `423` handling (they should treat it like an auth failure and not retry in a tight loop)

---

## Migration Steps

### Step 1: Run the database migration

```bash
./bin/app migrate
```

This adds two columns to the `clients` table:

- `failed_attempts INTEGER NOT NULL DEFAULT 0`
- `locked_until TIMESTAMPTZ` (nullable)

The migration is non-destructive and backward-compatible with the v0.10.0 binary.

### Step 2: Update binary or image

```bash
# Docker
docker pull allisson/secrets:v0.11.0

# Binary build
make build
```

### Step 3: Configure lockout variables (optional)

Override only if your policy requires stricter settings:

```dotenv
LOCKOUT_MAX_ATTEMPTS=10       # Default: 10
LOCKOUT_DURATION_MINUTES=30   # Default: 30
```

### Step 4: Deploy and verify

```bash
# Health checks
curl -sS http://localhost:8080/health
curl -sS http://localhost:8080/ready

# Verify normal auth still works
curl -sS -X POST http://localhost:8080/v1/token \
  -H "Content-Type: application/json" \
  -d '{"client_id":"<client-id>","client_secret":"<correct-secret>"}'
```

---

## Verification Checklist

1. ✅ Migration 000004 applied: `SELECT version FROM schema_migrations ORDER BY version DESC LIMIT 1` returns `4`
2. ✅ `GET /health` and `GET /ready` return 200
3. ✅ `POST /v1/token` with correct credentials returns a token
4. ✅ `POST /v1/token` with wrong credentials returns `401`
5. ✅ After 10 wrong attempts, `POST /v1/token` returns `423 Locked`
6. ✅ Successful auth resets `failed_attempts = 0` and clears `locked_until`

---

## Rollback Instructions

```bash
# 1. Stop API instances

# 2. Downgrade to v0.10.0 binary/image

# 3. Revert migration (drops the two new columns)
psql $DB_CONNECTION_STRING < migrations/postgresql/000004_add_account_lockout.down.sql
# or for MySQL:
mysql $DB_CONNECTION_STRING < migrations/mysql/000004_add_account_lockout.down.sql

# 4. Restart API instances
```

**Data safety**: The down migration only drops `failed_attempts` and `locked_until`. All other client data is preserved.

---

## Manual Unlock

If a legitimate client is locked and you need to restore access immediately, use the unlock API endpoint:

```bash
curl -X POST http://localhost:8080/v1/clients/<client-uuid>/unlock \
  -H "Authorization: Bearer <admin-token>"
```

Requires `write` capability on `/v1/clients/<client-uuid>`. Returns `200 OK` with the updated client object.

Alternatively, unlock directly via SQL (useful if the API is unavailable):

```sql
-- PostgreSQL
UPDATE clients SET failed_attempts = 0, locked_until = NULL WHERE id = '<client-uuid>';

-- MySQL
UPDATE clients SET failed_attempts = 0, locked_until = NULL WHERE id = UNHEX(REPLACE('<client-uuid>', '-', ''));
```

---

## See Also

- [v0.11.0 release notes](v0.11.0.md)
- [Authentication API: account lockout](../api/auth/authentication.md#account-lockout)
- [Configuration reference](../configuration.md#account-lockout)
- [Compatibility matrix](compatibility-matrix.md)
