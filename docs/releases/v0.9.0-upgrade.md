# v0.9.0 Upgrade Guide

> Release date: 2026-02-20

This guide covers upgrading from **v0.8.0** to **v0.9.0**.

---

## üìã Overview

v0.9.0 adds cryptographic audit log signing for tamper detection.

**Key Changes:**

- ‚úÖ Automatic HMAC-SHA256 signing of audit logs using KEK-derived signing keys
- ‚úÖ New CLI command: `verify-audit-logs` for integrity verification
- ‚ö†Ô∏è **Breaking:** Database migration 000003 (signature columns + FK constraints)
- ‚ö†Ô∏è **Breaking:** FK constraints prevent deletion of clients/KEKs with audit logs

---

## ‚ö†Ô∏è Breaking Changes

### 1. Database Migration Required (000003)

**Schema changes:**

- New columns: `signature` (BYTEA), `kek_id` (UUID FK), `is_signed` (BOOLEAN)
- New FK constraints: `fk_audit_logs_client_id`, `fk_audit_logs_kek_id`
- Existing audit logs marked as `is_signed=false` (legacy unsigned)

### 2. Foreign Key Constraints

**Impact:**

- Cannot delete clients with audit logs
- Cannot delete KEKs referenced by signed audit logs
- DELETE operations return FK constraint violation errors

**Workaround:** Deactivate clients instead of deleting:

```bash
curl -X PUT http://localhost:8080/v1/clients/<id> \
  -H "Authorization: Bearer ${TOKEN}" \
  -d '{"name":"Deactivated","is_active":false,"policy_document":{"policies":[]}}'
```

---

## üìã Prerequisites

1. ‚úÖ Current version: v0.8.0
2. ‚úÖ Database backup created
3. ‚úÖ KEK chain loaded (check: `curl http://localhost:8080/ready`)
4. ‚úÖ No orphaned client references (see pre-migration checks)

---

## üîç Pre-Migration Checks

### 1. Backup Database

```bash
pg_dump $DB_CONNECTION_STRING > backup-pre-v0.9.0-$(date +%s).sql
```

### 2. Check for Orphaned References

```sql
SELECT COUNT(*) FROM audit_logs al 
LEFT JOIN clients c ON al.client_id = c.id 
WHERE c.id IS NULL;
-- Expected: 0 (migration fails if > 0)
```

**If orphaned references found:**

```sql
-- Delete orphaned audit logs
DELETE FROM audit_logs WHERE client_id NOT IN (SELECT id FROM clients);
```

### 3. Verify KEK Chain

```bash
curl -sS http://localhost:8080/ready
# Expected: {"status": "ready", "active_kek_id": "..."}
```

---

## üöÄ Migration Steps

### 1. Stop API instances

```bash
docker-compose down  # or equivalent
```

### 2. Update binary/image

```bash
docker pull allisson/secrets:v0.9.0
```

### 3. Run migration

```bash
./bin/app migrate
# Expected: migration version 3 applied successfully
```

### 4. Restart API instances

```bash
docker-compose up -d
```

### 5. Verify startup

```bash
curl -sS http://localhost:8080/health  # {"status": "healthy"}
curl -sS http://localhost:8080/ready   # {"status": "ready", ...}
```

---

## ‚úÖ Post-Migration Verification

### 1. Verify Migration Applied

```sql
SELECT version FROM schema_migrations ORDER BY version DESC LIMIT 1;
-- Expected: 3
```

### 2. Verify New Logs Are Signed

```bash
# Create test secret (triggers audit log)
TOKEN=$(curl -sS -X POST http://localhost:8080/v1/token \
  -H "Content-Type: application/json" \
  -d '{"client_id":"<id>","client_secret":"<secret>"}' | jq -r '.token')

curl -sS -X POST http://localhost:8080/v1/secrets/test/v090 \
  -H "Authorization: Bearer ${TOKEN}" \
  -d '{"value":"djA5MC1zbW9rZQ=="}'

# Check audit log has signature
curl -sS http://localhost:8080/v1/audit-logs \
  -H "Authorization: Bearer ${TOKEN}" \
  | jq '.audit_logs[0] | {is_signed, kek_id}'
# Expected: {"is_signed": true, "kek_id": "..."}
```

### 3. Run Integrity Verification

```bash
TODAY=$(date +%Y-%m-%d)
./bin/app verify-audit-logs --start-date "$TODAY" --end-date "$TODAY"
# Expected: Status: PASSED ‚úì
```

### 4. Verify FK Constraints

```bash
# Attempt to delete client with audit logs
curl -X DELETE http://localhost:8080/v1/clients/<id-with-logs> \
  -H "Authorization: Bearer ${TOKEN}"
# Expected: 500 error with FK constraint violation
```

---

## üîÑ Rollback Instructions

If critical issues arise:

```bash
# 1. Stop API instances
docker-compose down

# 2. Restore database backup
psql $DB_CONNECTION_STRING < backup-pre-v0.9.0-*.sql

# 3. Downgrade to v0.8.0
docker pull allisson/secrets:v0.8.0
# Update docker-compose.yml

# 4. Restart
docker-compose up -d
```

‚ö†Ô∏è **WARNING:** Rollback deletes all signature data. Only rollback if absolutely necessary.

---

## üêõ Troubleshooting

### Migration Fails with FK Constraint Error

**Error:** `violates foreign key constraint "fk_audit_logs_client_id"`

**Solution:**

```sql
-- Delete orphaned audit logs
DELETE FROM audit_logs WHERE client_id NOT IN (SELECT id FROM clients);
-- Re-run migration
```

### New Audit Logs Not Signed

**Symptoms:** `is_signed=false` for new logs

**Solution:**

```bash
# Check KEK chain loaded
curl http://localhost:8080/ready

# If no active_kek_id, create KEK
./bin/app create-kek --algorithm aes-gcm
```

### Verification Reports Invalid Signatures

**Cause:** KEK rotated/deleted and old KEK not in chain

**Solution:**

```sql
-- Find KEK IDs in use
SELECT DISTINCT kek_id FROM audit_logs WHERE is_signed = true;

-- Ensure all KEKs exist
SELECT id FROM keks WHERE id IN ('<kek-id-1>', '<kek-id-2>');

-- If KEK missing, mark logs as legacy
UPDATE audit_logs SET is_signed = false WHERE kek_id = '<missing-kek-id>';
```

### Cannot Delete Client

**Expected behavior** - this preserves audit trail

**Solution:** Deactivate instead of delete (see Breaking Changes section)

---

## üìö Related Documentation

- [CHANGELOG.md](../../CHANGELOG.md#090---2026-02-20)
- [Release notes](RELEASES.md#090---2026-02-20)
- [CLI commands](../cli-commands.md#verify-audit-logs)
- [Audit logs API](../api/observability/audit-logs.md)
- [Compatibility matrix](compatibility-matrix.md)

---
