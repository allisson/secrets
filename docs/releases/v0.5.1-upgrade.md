# ⬆️ Upgrade Guide: v0.5.0 -> v0.5.1

> Release date: 2026-02-19

Use this guide to safely upgrade from `v0.5.0` to `v0.5.1`.

## Scope

- Release type: patch (`v0.5.1`)
- API compatibility: no `v1` contract changes
- Database migration: no new mandatory migration for this patch

## What Changed

- Fixed master key loading from `MASTER_KEYS` to preserve active key material after decode
- Added secure zeroing of all keychain-held master keys during `Close`
- Added regression test coverage for these memory lifecycle paths

## Recommended Upgrade Steps

1. Update image/binary to `v0.5.1`
2. Restart API instances with standard rolling rollout process
3. Run baseline checks:
   - `GET /health`
   - `GET /ready`
4. Run key-dependent smoke checks:
   - `POST /v1/token`
   - Secrets write/read
   - Transit encrypt/decrypt round-trip

## Quick Verification Commands

Use these after rollout to validate key-dependent paths quickly:

```bash
curl -sS http://localhost:8080/health

TOKEN_RESPONSE="$(curl -sS -X POST http://localhost:8080/v1/token \
  -H "Content-Type: application/json" \
  -d '{"client_id":"<client-id>","client_secret":"<client-secret>"}')"

CLIENT_TOKEN="$(printf '%s' "${TOKEN_RESPONSE}" | jq -r '.token')"

curl -sS -X POST http://localhost:8080/v1/secrets/upgrade/smoke \
  -H "Authorization: Bearer ${CLIENT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"value":"c21va2UtdjA1MQ=="}'

curl -sS -X GET http://localhost:8080/v1/secrets/upgrade/smoke \
  -H "Authorization: Bearer ${CLIENT_TOKEN}"

# Transit round-trip using an existing transit key name
# If the key does not exist yet in this environment, create it first:
# curl -sS -X POST http://localhost:8080/v1/transit/keys \
#   -H "Authorization: Bearer ${CLIENT_TOKEN}" \
#   -H "Content-Type: application/json" \
#   -d '{"name":"<transit-key-name>","algorithm":"aes-gcm"}'
curl -sS -X POST http://localhost:8080/v1/transit/keys/<transit-key-name>/encrypt \
  -H "Authorization: Bearer ${CLIENT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"plaintext":"dHJhbnNpdC12MDUxLXNtb2tl"}'

# Use ciphertext returned by the previous encrypt call
curl -sS -X POST http://localhost:8080/v1/transit/keys/<transit-key-name>/decrypt \
  -H "Authorization: Bearer ${CLIENT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"ciphertext":"<version>:<base64-ciphertext>"}'

# Expect decrypted plaintext to equal: dHJhbnNpdC12MDUxLXNtb2tl
```

## Rollback Notes

- If rollback is required, revert API instances to the last known stable image
- Keep additive schema migrations applied unless a validated rollback plan exists
- Re-run health and smoke checks after rollback

## See also

- [v0.5.1 release notes](v0.5.1.md)
- [Release compatibility matrix](compatibility-matrix.md)
- [Production rollout golden path](../operations/production-rollout.md)
