# ⬆️ Upgrade Guide: v0.5.1 -> v0.6.0

> Release date: 2026-02-19

Use this guide to safely upgrade from `v0.5.1` to `v0.6.0`.

## Scope

- Release type: minor (`v0.6.0`)
- API compatibility: no `v1` endpoint contract break
- Database migration: no new mandatory migration for this release

## What Changed

- Added KMS-backed master key loading mode (`KMS_PROVIDER`, `KMS_KEY_URI`)
- Added KMS flags to `create-master-key`
- Added `rotate-master-key` CLI command for staged master key rotation
- Added fail-fast validation for partial KMS configuration

## Recommended Upgrade Steps

1. Update image/binary to `v0.6.0`
2. Decide runtime key mode:
   - Keep legacy mode (no KMS vars set), or
   - Enable KMS mode (`KMS_PROVIDER` and `KMS_KEY_URI` both set)
3. Restart API instances with standard rolling rollout process
4. Run baseline checks:
   - `GET /health`
   - `GET /ready`
5. Run key-dependent smoke checks:
   - `POST /v1/token`
   - Secrets write/read
   - Transit encrypt/decrypt round-trip

## Decision Path

- Stay on legacy mode now:
  - Keep `KMS_PROVIDER` and `KMS_KEY_URI` unset
  - Upgrade binaries/images and validate normal crypto flows
- Adopt KMS mode now:
  - Set both `KMS_PROVIDER` and `KMS_KEY_URI`
  - Ensure all `MASTER_KEYS` entries are KMS ciphertext
  - Follow migration workflow in [KMS setup guide](../operations/kms-setup.md)
  - Track rollout gates in [KMS migration checklist](../operations/kms-migration-checklist.md)

## Quick Verification Commands

```bash
curl -sS http://localhost:8080/health
curl -sS http://localhost:8080/ready

TOKEN_RESPONSE="$(curl -sS -X POST http://localhost:8080/v1/token \
  -H "Content-Type: application/json" \
  -d '{"client_id":"<client-id>","client_secret":"<client-secret>"}')"

CLIENT_TOKEN="$(printf '%s' "${TOKEN_RESPONSE}" | jq -r '.token')"

curl -sS -X POST http://localhost:8080/v1/secrets/upgrade/v060 \
  -H "Authorization: Bearer ${CLIENT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"value":"djA2MC1zbW9rZQ=="}'

curl -sS -X GET http://localhost:8080/v1/secrets/upgrade/v060 \
  -H "Authorization: Bearer ${CLIENT_TOKEN}"
```

## Optional: Adopt KMS Mode During Upgrade

If you are migrating from legacy plaintext master keys to KMS mode, use:

1. [KMS setup guide](../operations/kms-setup.md) provider prerequisites
2. `create-master-key --kms-provider ... --kms-key-uri ...`
3. Staged dual-key migration and KEK rotation workflow from the KMS guide

## Rollback Notes

- If rollback is required, revert API instances to the previous stable image
- Revert only app version first; avoid destructive key/data rollback actions without a validated plan
- Re-run health and smoke checks after rollback

### Rollback matrix

| Upgrade path | First rollback action | Configuration rollback | Validation |
| --- | --- | --- | --- |
| Legacy mode (`KMS_*` unset) | Roll app image/binary back to previous stable version | Keep existing `MASTER_KEYS` and `ACTIVE_MASTER_KEY_ID` | `GET /health`, `GET /ready`, token + secrets/transit smoke checks |
| KMS mode (`KMS_*` set) | Roll app image/binary back to previous stable version | Keep KMS variables and KMS ciphertext `MASTER_KEYS` unchanged first; do not mix plaintext and KMS entries | Verify startup decrypt logs, then run token + secrets/transit smoke checks |

Use [KMS migration checklist](../operations/kms-migration-checklist.md) to document rollback readiness before cutover.

## See also

- [v0.6.0 release notes](v0.6.0.md)
- [Release compatibility matrix](compatibility-matrix.md)
- [KMS setup guide](../operations/kms-setup.md)
- [KMS migration checklist](../operations/kms-migration-checklist.md)
- [Production rollout golden path](../operations/production-rollout.md)
