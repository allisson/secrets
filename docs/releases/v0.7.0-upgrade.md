# ⬆️ Upgrade Guide: v0.6.0 -> v0.7.0

> Release date: 2026-02-20

Use this guide to safely upgrade from `v0.6.0` to `v0.7.0`.

## Scope

- Release type: minor (`v0.7.0`)
- API compatibility: no `v1` endpoint contract break
- Database migration: no new mandatory migration for this release

## What Changed

- Added IP-based token endpoint rate limiting for `POST /v1/token`
- Added new token endpoint throttling configuration (`RATE_LIMIT_TOKEN_*`)
- Token issuance can now return `429 Too Many Requests` with `Retry-After`

## Env Diff (copy/paste)

```diff
+ RATE_LIMIT_TOKEN_ENABLED=true
+ RATE_LIMIT_TOKEN_REQUESTS_PER_SEC=5.0
+ RATE_LIMIT_TOKEN_BURST=10
```

## Recommended Upgrade Steps

1. Update image/binary to `v0.7.0`
2. Add `RATE_LIMIT_TOKEN_*` variables to runtime configuration
3. Restart API instances with standard rolling rollout process
4. Run baseline checks:
   - `GET /health`
   - `GET /ready`
5. Run token and key-dependent checks:
   - `POST /v1/token`
   - Secrets write/read
   - Transit encrypt/decrypt round-trip

## Quick Verification Commands

```bash
curl -sS http://localhost:8080/health
curl -sS http://localhost:8080/ready

TOKEN_RESPONSE="$(curl -sS -X POST http://localhost:8080/v1/token \
  -H "Content-Type: application/json" \
  -d '{"client_id":"<client-id>","client_secret":"<client-secret>"}')"

CLIENT_TOKEN="$(printf '%s' "${TOKEN_RESPONSE}" | jq -r '.token')"

curl -sS -X POST http://localhost:8080/v1/secrets/upgrade/v070 \
  -H "Authorization: Bearer ${CLIENT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"value":"djA3MC1zbW9rZQ=="}'

curl -sS -X GET http://localhost:8080/v1/secrets/upgrade/v070 \
  -H "Authorization: Bearer ${CLIENT_TOKEN}"
```

## Optional: Token Endpoint Tuning Guidance

- If legitimate clients share NAT/proxy egress and hit token endpoint `429`, increase:
  - `RATE_LIMIT_TOKEN_REQUESTS_PER_SEC`
  - `RATE_LIMIT_TOKEN_BURST`
- Keep limits conservative enough to deter credential stuffing
- Validate trusted proxy configuration so `ClientIP` reflects real caller IPs

## Rollback Notes

- If rollback is required, revert API instances to the previous stable image
- Revert app version first; avoid destructive key/data rollback actions without a validated plan
- Re-run health and smoke checks after rollback

### Rollback matrix

| Upgrade path | First rollback action | Configuration rollback | Validation |
| --- | --- | --- | --- |
| `v0.6.0 -> v0.7.0` | Roll app image/binary back to previous stable version | Remove or ignore `RATE_LIMIT_TOKEN_*` additions as needed; keep existing crypto/KMS config unchanged | `GET /health`, `GET /ready`, token issuance, and secrets/transit smoke checks |

## See also

- [v0.7.0 release notes](v0.7.0.md)
- [Release compatibility matrix](compatibility-matrix.md)
- [API rate limiting](../api/rate-limiting.md)
- [Environment variables](../configuration/environment-variables.md)
- [Production rollout golden path](../operations/production-rollout.md)
