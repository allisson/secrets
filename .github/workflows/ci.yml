name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  docs:
    name: Docs Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Docs changelog guard (docs-only PRs)
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail

          CHANGED_FILES="$(git diff --name-only "${{ github.event.pull_request.base.sha }}" "${{ github.sha }}")"
          if [ -z "$CHANGED_FILES" ]; then
            exit 0
          fi

          docs_only=true
          changelog_updated=false

          while IFS= read -r file; do
            [ -z "$file" ] && continue

            if [ "$file" = "docs/CHANGELOG.md" ]; then
              changelog_updated=true
            fi

            case "$file" in
              docs/*|README.md)
                ;;
              *)
                docs_only=false
                ;;
            esac
          done <<EOF
          $CHANGED_FILES
          EOF

          if [ "$docs_only" = true ] && [ "$changelog_updated" = false ]; then
            echo "docs-only PRs must update docs/CHANGELOG.md"
            exit 1
          fi

      - name: Markdown lint
        uses: DavidAnson/markdownlint-cli2-action@v20
        with:
          config: .markdownlint.json
          globs: |
            README.md
            docs/**/*.md
            .github/pull_request_template.md

      - name: Example shape checks
        run: python3 docs/tools/check_example_shapes.py

      - name: Markdown link check (offline)
        uses: lycheeverse/lychee-action@v2
        with:
          args: --offline --include-fragments --no-progress "README.md" "docs/**/*.md" ".github/pull_request_template.md"

  test:
    name: Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432

      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: testdb
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpassword
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u testuser -ptestpassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 3307:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.5"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest

      - name: Run tests
        run: make test
