# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
# Build
make build                          # Compiles to bin/app

# Run
./bin/app server                    # Start HTTP server
./bin/app migrate                   # Run DB migrations

# Test
make test                           # Run all tests with race detector and coverage
make test-with-db                   # Start test DBs via docker compose, run tests, stop DBs

# Run a single test or subtest
go test -v -race -run TestKekUseCase_Create ./internal/crypto/usecase
go test -v -race -run "TestKekUseCase_Create/Success" ./internal/crypto/usecase

# Lint (golangci-lint with gosec, gocritic, goimports, golines — max line 110)
make lint

# Regenerate mocks (mockery)
make mocks

# Docs checks (run before opening a PR with docs changes)
make docs-lint           # markdownlint + lychee offline link check (runs via Docker)
make docs-check-examples # Validate JSON shapes in docs examples
make docs-check-metadata # Validate release/API version labels across docs
make docs-check-release-tags  # Validate pinned Docker image tags in docs
```

## Local Development Setup

1. `make build`
2. `./bin/app create-master-key --id default` → paste output into `.env`
3. `cp .env.example .env` and fill in `MASTER_KEYS` and `ACTIVE_MASTER_KEY_ID`
4. `make dev-postgres` (or `make dev-mysql`)
5. `./bin/app migrate`
6. `./bin/app create-kek --algorithm aes-gcm`
7. `./bin/app server`

## Architecture

### Domain Packages

Each feature domain lives under `internal/<domain>/` with these consistent sub-layers:

- `domain/` — entities, invariants, errors, constants
- `usecase/` — business logic interfaces (defined here) and orchestration (transactions, policy decisions)
- `repository/` — PostgreSQL and MySQL persistence implementations
- `service/` — reusable technical services (crypto, hashing, token generation)
- `http/` — Gin handlers, DTOs, request validation

Domains: `auth`, `crypto`, `secrets`, `transit`, `tokenization`

Shared infrastructure: `internal/database/` (connection + TxManager), `internal/config/`, `internal/http/` (server, middleware, CORS), `internal/metrics/`, `internal/errors/`, `internal/testutil/`

### Dependency Injection

`internal/app/di.go` contains a `Container` struct that wires everything together using `sync.Once` for lazy initialization. This is the single assembly point — repository driver selection (postgres vs mysql), metrics wrapping, and all cross-cutting concerns happen here.

### Encryption Model

```
Master Key → KEK → DEK → Secret Data      (Secrets API: server stores ciphertext)
Master Key → KEK → DEK → Transit Key      (Transit API: server returns crypto result, stores nothing)
Master Key → KEK → DEK → Tokenization Key (Tokenization API: server persists token↔encrypted plaintext)
```

- Master Key: loaded from env (`MASTER_KEYS`, `ACTIVE_MASTER_KEY_ID`) or KMS (`KMS_PROVIDER`, `KMS_KEY_URI`)
- KEK: created via `./bin/app create-kek`, rotated via `./bin/app rotate-kek`
- DEK: generated per secret version
- Algorithms: AES-GCM or ChaCha20-Poly1305

### Key Patterns

- **Interfaces in usecase packages**: All repository and use case interfaces are defined in `internal/<domain>/usecase/`. Implementations live in `repository/` or `service/` packages and are injected by the DI container.
- **Mocks**: Generated by mockery into `<package>/mocks/mocks.go` for every interface listed in `.mockery.yaml`. Run `make mocks` after changing interfaces.
- **Transactions**: Context-based via `database.TxManager`; use cases call `txManager.WithTx(ctx, func)`.
- **Metrics decorator**: Use cases are optionally wrapped with a metrics decorator (e.g., `NewSecretUseCaseWithMetrics`) when `METRICS_ENABLED=true`.
- **All IDs are UUIDv7**.
- **Audit logs**: Every mutating handler writes to the audit log via `AuditLogUseCase`. Entries are HMAC-SHA256 signed for tamper detection.
- **Authorization**: Capability-based with path-matching policies (`exact`, `wildcard *`, `prefix *path*`) enforced in middleware.

### HTTP Layer

- Framework: Gin, set to `release` mode unless `LOG_LEVEL=debug`
- Rate limiting: per-client for authenticated endpoints; per-IP for `POST /v1/token`
- Middleware stack wired in `internal/http/server.go` → `SetupRouter`
- Auth middleware validates bearer tokens using `TokenUseCase` + `TokenService`

## Docs Conventions

- `docs/metadata.json` is the canonical source for release and API version labels — keep `README.md` and `docs/README.md` in sync with it.
- `docs/openapi.yaml` is the canonical API contract.
- For any PR that changes API-facing code (`internal/*/http/*.go`, `cmd/app/commands/*.go`, `migrations/*`), update the corresponding docs in the same PR.
- New docs pages need a `Last updated:` header; run `make docs-check-metadata` to validate.
- Use unpinned Docker image reference (`allisson/secrets`) in all documentation.
